# allow pass CFLAGS, replace -O, -pg,-DPROFILING with $(CFAGS)
Makefiles=$(find . -type f -name Makefile\*)
%{__sed} -i -e 's@^CFLAGS[ \t]*=@override CFLAGS += @' $Makefiles
%{__sed} -i -e 's@\(^override CFLAGS += .*\)-O \(.*\)@\1\2@' $Makefiles
%{__sed} -i -e 's@^CCFLAGS[ \t]*=\(.*\)@override CCFLAGS += \1 $(CFLAGS)@' $Makefiles
%{__sed} -i -e 's@-pg -O -DPROFILING@ $(CFLAGS) @' asmrun/Makefile
%{__sed} -i -e 's@-O@$(CFLAGS)@' otherlibs/systhreads/Makefile

diff -ur ocaml-3.11.0/asmrun/Makefile ocaml-3.11.0.CFLAGS/asmrun/Makefile
--- ocaml-3.11.0/asmrun/Makefile	2007-11-15 14:21:15.000000000 +0100
+++ ocaml-3.11.0.CFLAGS/asmrun/Makefile	2009-02-16 12:18:06.599221049 +0100
@@ -18,9 +18,9 @@
 CC=$(NATIVECC)
 FLAGS=-I../byterun -DCAML_NAME_SPACE -DNATIVE_CODE \
       -DTARGET_$(ARCH) -DSYS_$(SYSTEM) $(IFLEXDIR)
-CFLAGS=$(FLAGS) -O $(NATIVECCCOMPOPTS)
+override CFLAGS += $(FLAGS) $(NATIVECCCOMPOPTS)
 DFLAGS=$(FLAGS) -g -DDEBUG $(NATIVECCCOMPOPTS)
-PFLAGS=$(FLAGS) -pg -O -DPROFILING $(NATIVECCPROFOPTS)
+PFLAGS=$(FLAGS)  $(CFLAGS)  $(NATIVECCPROFOPTS)
 
 COBJS=startup.o main.o fail.o roots.o globroots.o signals.o signals_asm.o \
   misc.o freelist.o major_gc.o minor_gc.o memory.o alloc.o compare.o ints.o \
diff -ur ocaml-3.11.0/asmrun/Makefile.nt ocaml-3.11.0.CFLAGS/asmrun/Makefile.nt
--- ocaml-3.11.0/asmrun/Makefile.nt	2007-11-15 14:21:15.000000000 +0100
+++ ocaml-3.11.0.CFLAGS/asmrun/Makefile.nt	2009-02-16 12:18:01.212550815 +0100
@@ -16,7 +16,7 @@
 include ../config/Makefile
 
 CC=$(NATIVECC)
-CFLAGS=-I../byterun -DNATIVE_CODE -DTARGET_$(ARCH) -DSYS_$(SYSTEM) $(NATIVECCCOMPOPTS)
+override CFLAGS += -I../byterun -DNATIVE_CODE -DTARGET_$(ARCH) -DSYS_$(SYSTEM) $(NATIVECCCOMPOPTS)
 
 COBJS=startup.$(O) main.$(O) fail.$(O) roots.$(O) signals.$(O) signals_asm.$(O) \
   misc.$(O) freelist.$(O) major_gc.$(O) minor_gc.$(O) memory.$(O) alloc.$(O) \
diff -ur ocaml-3.11.0/byterun/Makefile ocaml-3.11.0.CFLAGS/byterun/Makefile
--- ocaml-3.11.0/byterun/Makefile	2008-11-08 17:29:02.000000000 +0100
+++ ocaml-3.11.0.CFLAGS/byterun/Makefile	2009-02-16 12:18:01.212550815 +0100
@@ -15,7 +15,7 @@
 
 include Makefile.common
 
-CFLAGS=-DCAML_NAME_SPACE -O $(BYTECCCOMPOPTS) $(IFLEXDIR)
+override CFLAGS += -DCAML_NAME_SPACE $(BYTECCCOMPOPTS) $(IFLEXDIR)
 DFLAGS=-DCAML_NAME_SPACE -g -DDEBUG $(BYTECCCOMPOPTS)
 
 OBJS=$(COMMONOBJS) unix.o main.o
diff -ur ocaml-3.11.0/byterun/Makefile.nt ocaml-3.11.0.CFLAGS/byterun/Makefile.nt
--- ocaml-3.11.0/byterun/Makefile.nt	2008-11-26 14:26:53.000000000 +0100
+++ ocaml-3.11.0.CFLAGS/byterun/Makefile.nt	2009-02-16 12:18:01.215883365 +0100
@@ -15,7 +15,7 @@
 
 include Makefile.common
 
-CFLAGS=-DOCAML_STDLIB_DIR='"$(LIBDIR)"' $(IFLEXDIR)
+override CFLAGS += -DOCAML_STDLIB_DIR='"$(LIBDIR)"' $(IFLEXDIR)
 
 DBGO=d.$(O)
 OBJS=$(COMMONOBJS:.o=.$(O)) win32.$(O) main.$(O)
diff -ur ocaml-3.11.0/otherlibs/Makefile ocaml-3.11.0.CFLAGS/otherlibs/Makefile
--- ocaml-3.11.0/otherlibs/Makefile	2007-11-08 10:17:47.000000000 +0100
+++ ocaml-3.11.0.CFLAGS/otherlibs/Makefile	2009-02-16 12:18:01.282552384 +0100
@@ -17,7 +17,7 @@
 
 CAMLC=$(ROOTDIR)/ocamlcomp.sh
 CAMLOPT=$(ROOTDIR)/ocamlcompopt.sh
-CFLAGS=-I$(ROOTDIR)/byterun -O $(SHAREDCCCOMPOPTS) $(EXTRACFLAGS)
+override CFLAGS += -I$(ROOTDIR)/byterun $(SHAREDCCCOMPOPTS) $(EXTRACFLAGS)
 
 include ../Makefile.shared
 # Note .. is the current directory (this makefile is included from
diff -ur ocaml-3.11.0/otherlibs/Makefile.nt ocaml-3.11.0.CFLAGS/otherlibs/Makefile.nt
--- ocaml-3.11.0/otherlibs/Makefile.nt	2007-11-08 10:17:48.000000000 +0100
+++ ocaml-3.11.0.CFLAGS/otherlibs/Makefile.nt	2009-02-16 12:18:01.282552384 +0100
@@ -17,7 +17,7 @@
 
 CAMLC=$(CAMLRUN) $(ROOTDIR)/ocamlc -nostdlib -I $(ROOTDIR)/stdlib -w s
 CAMLOPT=$(CAMLRUN) $(ROOTDIR)/ocamlopt -nostdlib -I $(ROOTDIR)/stdlib -w s
-CFLAGS=-I$(ROOTDIR)/byterun $(SHAREDCCCOMPOPTS) $(EXTRACFLAGS)
+override CFLAGS += -I$(ROOTDIR)/byterun $(SHAREDCCCOMPOPTS) $(EXTRACFLAGS)
 
 include ../Makefile.shared
 # Note .. is the current directory (this makefile is included from
diff -ur ocaml-3.11.0/otherlibs/labltk/browser/Makefile.nt ocaml-3.11.0.CFLAGS/otherlibs/labltk/browser/Makefile.nt
--- ocaml-3.11.0/otherlibs/labltk/browser/Makefile.nt	2008-12-03 14:03:18.000000000 +0100
+++ ocaml-3.11.0.CFLAGS/otherlibs/labltk/browser/Makefile.nt	2009-02-16 12:18:01.272552219 +0100
@@ -1,6 +1,6 @@
 OTHERSLIB=-I $(OTHERS)/win32unix -I $(OTHERS)/str -I $(OTHERS)/systhreads
 
-CCFLAGS=-I../../../byterun $(TK_DEFS)
+override CCFLAGS += -I../../../byterun $(TK_DEFS) $(CFLAGS)
 
 include ../support/Makefile.common
 
diff -ur ocaml-3.11.0/otherlibs/labltk/support/Makefile ocaml-3.11.0.CFLAGS/otherlibs/labltk/support/Makefile
--- ocaml-3.11.0/otherlibs/labltk/support/Makefile	2008-04-22 09:38:07.000000000 +0200
+++ ocaml-3.11.0.CFLAGS/otherlibs/labltk/support/Makefile	2009-02-16 12:18:01.282552384 +0100
@@ -12,7 +12,7 @@
       cltkFile.$(O) cltkMain.$(O) cltkMisc.$(O) cltkTimer.$(O) \
       cltkVar.$(O) cltkWait.$(O) cltkImg.$(O)
 
-CCFLAGS=-I../../../byterun $(TK_DEFS) $(SHAREDCCCOMPOPTS)
+override CCFLAGS += -I../../../byterun $(TK_DEFS) $(SHAREDCCCOMPOPTS) $(CFLAGS)
 
 COMPFLAGS=-I $(OTHERS)/win32unix -I $(OTHERS)/unix
 THFLAGS=-I $(OTHERS)/systhreads -I $(OTHERS)/threads
diff -ur ocaml-3.11.0/otherlibs/labltk/tkanim/Makefile ocaml-3.11.0.CFLAGS/otherlibs/labltk/tkanim/Makefile
--- ocaml-3.11.0/otherlibs/labltk/tkanim/Makefile	2007-12-12 15:09:45.000000000 +0100
+++ ocaml-3.11.0.CFLAGS/otherlibs/labltk/tkanim/Makefile	2009-02-16 12:18:01.282552384 +0100
@@ -4,7 +4,7 @@
 include ../support/Makefile.common
 
 COMPFLAGS=-I ../support -I ../camltk -I ../../unix -I ../../win32unix
-CCFLAGS=-I../../../byterun -I../support $(TK_DEFS) $(SHAREDCCCOMPOPTS)
+override CCFLAGS += -I../../../byterun -I../support $(TK_DEFS) $(SHAREDCCCOMPOPTS) $(CFLAGS)
 
 all: tkanim.cma libtkanim.$(A)
 opt: tkanim.cmxa libtkanim.$(A)
diff -ur ocaml-3.11.0/otherlibs/num/test/Makefile ocaml-3.11.0.CFLAGS/otherlibs/num/test/Makefile
--- ocaml-3.11.0/otherlibs/num/test/Makefile	2008-09-10 18:02:52.000000000 +0200
+++ ocaml-3.11.0.CFLAGS/otherlibs/num/test/Makefile	2009-02-16 12:18:01.285892127 +0100
@@ -18,7 +18,7 @@
 CAMLC=../../../boot/ocamlrun ../../../ocamlc -I ../../../stdlib -w A -warn-error A
 CAMLOPT=../../../boot/ocamlrun ../../../ocamlopt -I ../../../stdlib
 CC=$(BYTECC)
-CFLAGS=-I.. -I../../../byterun $(BYTECCCOMPOPTS)
+override CFLAGS += -I.. -I../../../byterun $(BYTECCCOMPOPTS)
 
 test: test.byt test.opt test_pi
 	if $(SUPPORTS_SHARED_LIBRARIES); \
diff -ur ocaml-3.11.0/otherlibs/num/test/Makefile.nt ocaml-3.11.0.CFLAGS/otherlibs/num/test/Makefile.nt
--- ocaml-3.11.0/otherlibs/num/test/Makefile.nt	2004-04-01 15:10:12.000000000 +0200
+++ ocaml-3.11.0.CFLAGS/otherlibs/num/test/Makefile.nt	2009-02-16 12:18:01.285892127 +0100
@@ -18,7 +18,7 @@
 CAMLC=../../../boot/ocamlrun ../../../ocamlc -I ../../../stdlib -I ..
 CAMLOPT=../../../boot/ocamlrun ../../../ocamlopt -I ../../../stdlib -I ..
 CC=$(BYTECC)
-CFLAGS=-I.. $(BYTECCCOMPOPTS)
+override CFLAGS += -I.. $(BYTECCCOMPOPTS)
 
 test: test.byt test.opt
 	../../../byterun/ocamlrun -I .. ./test.byt
diff -ur ocaml-3.11.0/otherlibs/systhreads/Makefile ocaml-3.11.0.CFLAGS/otherlibs/systhreads/Makefile
--- ocaml-3.11.0/otherlibs/systhreads/Makefile	2008-07-15 17:31:32.000000000 +0200
+++ ocaml-3.11.0.CFLAGS/otherlibs/systhreads/Makefile	2009-02-16 12:18:13.469214951 +0100
@@ -35,7 +35,7 @@
 	$(MKLIB) -o threads $(BYTECODE_C_OBJS)
 
 posix_b.o: posix.c
-	$(BYTECC) -O -I../../byterun $(BYTECCCOMPOPTS) $(SHAREDCCCOMPOPTS) \
+	$(BYTECC) $(CFLAGS) -I../../byterun $(BYTECCCOMPOPTS) $(SHAREDCCCOMPOPTS) \
 	   -c posix.c
 	mv posix.o posix_b.o
 
@@ -45,7 +45,7 @@
 	$(AR) rc libthreadsnat.a $(NATIVECODE_C_OBJS)
 
 posix_n.o: posix.c
-	$(NATIVECC) -O -I../../asmrun -I../../byterun $(NATIVECCCOMPOPTS) $(SHAREDCCCOMPOPTS) -DNATIVE_CODE -DTARGET_$(ARCH) -DSYS_$(SYSTEM) -c posix.c
+	$(NATIVECC) $(CFLAGS) -I../../asmrun -I../../byterun $(NATIVECCCOMPOPTS) $(SHAREDCCCOMPOPTS) -DNATIVE_CODE -DTARGET_$(ARCH) -DSYS_$(SYSTEM) -c posix.c
 	mv posix.o posix_n.o
 
 threads.cma: $(THREAD_OBJS)
diff -ur ocaml-3.11.0/otherlibs/systhreads/Makefile.nt ocaml-3.11.0.CFLAGS/otherlibs/systhreads/Makefile.nt
--- ocaml-3.11.0/otherlibs/systhreads/Makefile.nt	2007-11-06 16:16:56.000000000 +0100
+++ ocaml-3.11.0.CFLAGS/otherlibs/systhreads/Makefile.nt	2009-02-16 12:18:01.285892127 +0100
@@ -20,7 +20,7 @@
 CAMLOPT=../../boot/ocamlrun ../../ocamlopt -I ../../stdlib -I ../win32unix
 COMPFLAGS=-warn-error A -g
 MKLIB=../../boot/ocamlrun ../../tools/ocamlmklib
-CFLAGS=-I../../byterun $(EXTRACFLAGS)
+override CFLAGS += -I../../byterun $(EXTRACFLAGS)
 
 CAMLOBJS=thread.cmo mutex.cmo condition.cmo event.cmo threadUnix.cmo
 CMIFILES=$(CAMLOBJS:.cmo=.cmi)
diff -ur ocaml-3.11.0/otherlibs/threads/Makefile ocaml-3.11.0.CFLAGS/otherlibs/threads/Makefile
--- ocaml-3.11.0/otherlibs/threads/Makefile	2008-10-08 15:07:13.000000000 +0200
+++ ocaml-3.11.0.CFLAGS/otherlibs/threads/Makefile	2009-02-16 12:18:01.285892127 +0100
@@ -16,7 +16,7 @@
 include ../../config/Makefile
 
 CC=$(BYTECC)
-CFLAGS=-I../../byterun -O $(BYTECCCOMPOPTS) $(SHAREDCCCOMPOPTS) -g
+override CFLAGS += -I../../byterun $(BYTECCCOMPOPTS) $(SHAREDCCCOMPOPTS) -g
 CAMLC=../../ocamlcomp.sh -I ../unix
 MKLIB=../../boot/ocamlrun ../../tools/ocamlmklib
 COMPFLAGS=-warn-error A
diff -ur ocaml-3.11.0/win32caml/Makefile ocaml-3.11.0.CFLAGS/win32caml/Makefile
--- ocaml-3.11.0/win32caml/Makefile	2007-11-15 14:21:15.000000000 +0100
+++ ocaml-3.11.0.CFLAGS/win32caml/Makefile	2009-02-16 12:18:01.289259949 +0100
@@ -16,7 +16,7 @@
 include ../config/Makefile
 
 CC=$(BYTECC)
-CFLAGS=$(BYTECCCOMPOPTS)
+override CFLAGS += $(BYTECCCOMPOPTS)
 
 OBJS=startocaml.$(O) ocamlres.$(O) ocaml.$(O) menu.$(O) \
   history.$(O) editbuffer.$(O)
diff -ur ocaml-3.11.0/yacc/Makefile ocaml-3.11.0.CFLAGS/yacc/Makefile
--- ocaml-3.11.0/yacc/Makefile	2007-02-07 15:49:42.000000000 +0100
+++ ocaml-3.11.0.CFLAGS/yacc/Makefile	2009-02-16 12:18:01.289259949 +0100
@@ -17,7 +17,7 @@
 include ../config/Makefile
 
 CC=$(BYTECC)
-CFLAGS=-O -DNDEBUG $(BYTECCCOMPOPTS)
+override CFLAGS += -DNDEBUG $(BYTECCCOMPOPTS)
 
 OBJS= closure.o error.o lalr.o lr0.o main.o mkpar.o output.o reader.o \
   skeleton.o symtab.o verbose.o warshall.o
